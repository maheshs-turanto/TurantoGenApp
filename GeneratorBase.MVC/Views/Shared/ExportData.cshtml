@model IList<GeneratorBase.MVC.Models.ExportData>
@{
    ViewBag.Title = "Export Data";
    Layout = null;
}
<div>
    @Html.Hidden("hdnExportId", (int)ViewBag.ExportId)
    <label>
        <i class="fa fa-minus-circle"></i>
    </label>
    <input type="checkbox" disabled="true" checked="true" />
    <strong> @GeneratorBase.MVC.ModelReflector.Entities.FirstOrDefault(fd => fd.Name == Convert.ToString(ViewData["EntityName"])).DisplayName </strong>
    <ul style="list-style-type:none;">
        @foreach (var str in Model)
        {
            var chkId = DateTime.Now.Ticks;
            <li id="li_@str.AssociationValue">
                @if (str.IsNested)
                {
                    <a id="a_@str.AssociationValue" onclick="exportdata('@str.EntityName','@str.AssociationValue','@str.FilterQuery','@Url.Action("NestedExportAllData")')">
                        <i class="fa fa-plus-circle"></i>
                    </a>
                }
                else
                {
                    <label>
                        <i class="fa fa-minus-circle"></i>
                    </label>
                }
                <input id="chk_@str.AssociationValue@chkId"  name="chk_@str.AssociationValue@chkId" type="checkbox" value="@str.AssociationName" checked="@str.IsSelected" onclick="nestedcheck('@str.EntityName','@str.AssociationValue','@str.FilterQuery','@chkId');" /> <span id="spn_@str.AssociationValue">@str.DisplayName</span>
            </li>
        }
    </ul>
</div>

<script>
    function exportdata(entityName, association, filterquery, dataurl)
    {
        dataurl += "?EntityName=" + entityName + "+&FilterQuery=" + filterquery;
        var exportid = $("#hdnExportId").val();
        if (exportid > 0) { dataurl += "&id=" + exportid; }
        
        $.ajax({
            async: false,
            type: "POST",
            url: dataurl,
            success: function (data) {
                var isdata = false;
                var ulid = "ul_" + association;
                var ulappend = "<ul id='" + ulid + "' style='list-style-type:none;'>";
                for (var i = 0; i < data.length; i++)
                {
                    var keyval = data[i].DisplayName;
                    var key = data[i].EntityName;
                    var Associate = data[i].AssociationName;
                    var fltquery = data[i].FilterQuery;
                    var AssociateVal = data[i].AssociationValue;
                    var chkId = $.now();

                    ulappend += "<li id='li_" + AssociateVal + "'>";
                    if (data[i].IsNested)
                    {
                        ulappend += "<a id = 'a_" + AssociateVal + "' onclick=\"exportdata('" + key + "','" + AssociateVal + "','" + fltquery + "','" + '@Html.Raw(Url.Action("NestedExportAllData"))' + "');\"> <i class='fa fa-plus-circle'></i></a> ";
                    }
                    else
                    {
                        ulappend += "<label'> <i class='fa fa-minus-circle'></i></label> ";
                    }
                    if (data[i].IsSelected)
                        ulappend += " <input id='chk_" + AssociateVal + chkId + "' name='chk_" + AssociateVal + chkId + "' type='checkbox' checked='true' value='" + Associate + "' onclick=\"nestedcheck('" + key + "','" + AssociateVal + "','" + fltquery + "', '" + chkId + "');\"></input> <span id='spn_" + AssociateVal + "'>" + keyval + "</span>";
                    else
                        ulappend += " <input id='chk_" + AssociateVal + chkId + "' name='chk_" + AssociateVal + chkId + "' type='checkbox' value='" + Associate + "' onclick=\"nestedcheck('" + key + "','" + AssociateVal + "','" + fltquery + "', '" + chkId + "');\"></input> <span id='spn_" + AssociateVal + "'>" + keyval + "</span>";

                    ulappend += "</li>";

                    if (!isdata)
                        isdata = true;
                }
                if (isdata)
                    ulappend += '</ul>';

                $("#spn_" + association).after(ulappend);
                $("#a_" + association).removeAttr('onclick');
                $("#a_" + association).attr("onclick", "removenested('" + ulid + "','" + entityName + "','" + association+"','" + filterquery + "','@Url.Action("NestedExportAllData")');");
                $("#a_" + association).html(" <i class='fa fa-minus-circle'></i>");
            },
            error: function (jqXHR, textStatus, errorThrown) {
            }
        });
    }

    function removenested(ulid, entityName, association, filterquery, dataurl)
    {
        $("#" + ulid).remove();
        $("#a_" + association).removeAttr('onclick');
        $("#a_" + association).attr("onclick", "exportdata('" + entityName + "','" + association+"','" + filterquery+"','" + dataurl + "')")
        $("#a_" + association).html(" <i class='fa fa-plus-circle'></i>")
    }

    function nestedcheck(entityName, association, filterquery, chkId)
    {
        if ($("#a_" + association).is(":visible") && $("#chk_" + association + chkId).prop("checked"))
        {
            if ($("#ul_" + association).is(":visible"))
                $("#ul_" + association).remove();
            exportdata(entityName,association,filterquery,'@Url.Action("NestedExportAllData")');
        }
        if ($("#chk_" + association + chkId).prop("checked")) {
            var hiddenfield = "<input type='hidden' id='hdn_" + association + chkId + "' name='hdn_" + association + chkId + "' value= '" + filterquery + "' />";
            $("#chk_" + association + chkId).after(hiddenfield);
        }
        else
        {
            if ($("#hdn_" + association + chkId).is(":hidden"))
                $("#hdn_" + association + chkId).remove();
        }
        //$("#li_" + entityName).find('li').find(":checkbox").prop("checked", $("#chk_" + entityName).prop("checked"));
    }
</script>